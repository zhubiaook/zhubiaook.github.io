---
layout: post
title: 'MySQL日志和备份'
date: 2017-11-11
author: "zhubiao"
header-img: "img/post-bg-universe.jpg"
categories: Linux
tags: MySQL
---
<!DOCTYPE html><html><head><title>Untitled</title><meta charset='utf-8'><link href='https://dn-maxiang.qbox.me/res-min/themes/marxico.css' rel='stylesheet'><style>
.note-content  {font-family: "Helvetica Neue", Arial, "Hiragino Sans GB", STHeiti, "Microsoft YaHei", "WenQuanYi Micro Hei", SimSun, Song, sans-serif;}

.note-content * Tomorrow Night Eighties Theme */




.hljs-comment, .note-content 
.hljs-quote {color: #999999;}
.note-content .hljs-variable, .note-content 
.hljs-template-variable, .note-content 
.hljs-tag, .note-content 
.hljs-name, .note-content 
.hljs-selector-id, .note-content 
.hljs-selector-class, .note-content 
.hljs-regexp, .note-content 
.hljs-deletion {color: #f2777a;}
.note-content .hljs-number, .note-content 
.hljs-built_in, .note-content 
.hljs-builtin-name, .note-content 
.hljs-literal, .note-content 
.hljs-type, .note-content 
.hljs-params, .note-content 
.hljs-meta, .note-content 
.hljs-link {color: #f99157;}
.note-content .hljs-attribute {color: #ffcc66;}
.note-content .hljs-string, .note-content 
.hljs-symbol, .note-content 
.hljs-bullet, .note-content 
.hljs-addition {color: #99cc99;}
.note-content .hljs-title, .note-content 
.hljs-section {color: #6699cc;}
.note-content .hljs-keyword, .note-content 
.hljs-selector-tag {color: #cc99cc;}
.note-content .hljs {display: block; overflow-x: auto; background: #2d2d2d; color: #cccccc; padding: 0.5em;}
.note-content .hljs-emphasis {font-style: italic;}
.note-content .hljs-strong {font-weight: bold;}
</style></head><body><div id='preview-contents' class='note-content'>
                        
                    

<p><font size="5" color="#0099ff"> <br>
MyCLI 的安装</font> <br>
MyCLI 是一个用在MySQL，MariaDB，Percona数据上的客户端工具，其可以高亮显示SQL语句，并有语法提示和补全功能</p>

<pre class="prettyprint hljs-dark"><code class="hljs vala"><div class="hljs-line"><span class="hljs-meta"># 1. 配置好epel源</span>
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-meta"># 2. 安装python-pip</span>
</div><div class="hljs-line">yum -y install python34-pip.noarch
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-meta"># 3. 安装MyCLI</span>
</div><div class="hljs-line">pip3<span class="hljs-number">.4</span> install mycli
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-meta"># 4. 连接MySQL</span>
</div><div class="hljs-line">mycli -uUSER -pPASSWORD -hHOST
</div></code></pre>

<p><font size="5" color="#0099ff"> <br>
MySQL 日志</font></p>

<p>MySQL 日志文件有</p>

<ul><li>查询日志</li>
<li>慢查询日志</li>
<li>错误日志</li>
<li>二进制日志</li>
<li>事务日志</li>
<li>中继日志</li>
</ul>

<p><font size="4" color="#ff5809"> <br>
查询日志 <br>
</font> <br>
查询日志记录了所有对MySQL数据库的请求信息，不仅仅是查询，包括所有的操作，比如对数据库、表的操作及增删改查等，错误的操作也会被记录。</p>

<ol start="1"><li rel="1">查询日志默认是关闭的，一般情况不开启查询日志，占用空间过大，若调试需开启查询日志，开启方法为</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs css"><div class="hljs-line"><span class="hljs-selector-tag">SET</span> @@<span class="hljs-keyword">global</span>.<span class="hljs-keyword">general_log</span>=<span class="hljs-keyword">ON</span>;
</div></code></pre>

<ol start="2"><li rel="2">查询日志可以记录在MySQL表中，也可以记录在文件中，设置方法如下</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs css"><div class="hljs-line"># 记录于文件中
</div><div class="hljs-line"><span class="hljs-selector-tag">SET</span> @@<span class="hljs-keyword">global</span>.<span class="hljs-keyword">log_output</span>='<span class="hljs-keyword">FILE</span>';
</div><div class="hljs-line">
</div><div class="hljs-line"># 记录于表表中
</div><div class="hljs-line"><span class="hljs-selector-tag">SET</span> @@<span class="hljs-keyword">global</span>.<span class="hljs-keyword">log_output</span>='<span class="hljs-keyword">TABLE</span>';
</div><div class="hljs-line">
</div><div class="hljs-line"># 记录于文件和表中
</div><div class="hljs-line"><span class="hljs-selector-tag">SET</span> @@<span class="hljs-keyword">global</span>.<span class="hljs-keyword">log_output</span>='<span class="hljs-keyword">TABLE</span>,<span class="hljs-keyword">FILE</span>';
</div></code></pre>

<p>查询表中的查询日志文件</p>



<pre class="prettyprint hljs-dark"><code class="hljs sql"><div class="hljs-line"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> mysql.general_log;
</div></code></pre>

<ol start="3"><li rel="3">设置查询日志文件存储的路径</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs css"><div class="hljs-line"><span class="hljs-selector-tag">SET</span> @@<span class="hljs-keyword">global</span>.<span class="hljs-keyword">general_log_file</span>="<span class="hljs-keyword">FILE_NAME</span>";
</div><div class="hljs-line"><span class="hljs-selector-tag">select</span> @@<span class="hljs-keyword">global</span>.<span class="hljs-keyword">general_log_file</span>;
</div></code></pre>

<ol start="4"><li rel="4">查询记录于文件中的查询日志</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs crystal"><div class="hljs-line">cat /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">mysql</span>/<span class="hljs-title">node1</span>.<span class="hljs-title">log</span></span>
</div></code></pre>

<p><font size="4" color="#ff5809"> <br>
慢查询日志 <br>
</font> <br>
慢查询：查询时间超出指定时长的查询</p>

<ol start="1"><li rel="1">查询时长</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs css"><div class="hljs-line"><span class="hljs-selector-tag">set</span> @@<span class="hljs-keyword">long_query_time</span>=<span class="hljs-keyword">5</span>;
</div></code></pre>

<ol start="2"><li rel="2">存储方式的设定与查询日志的设定方式一样</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs css"><div class="hljs-line"># 记录于文件中
</div><div class="hljs-line"><span class="hljs-selector-tag">SET</span> @@<span class="hljs-keyword">global</span>.<span class="hljs-keyword">log_output</span>='<span class="hljs-keyword">FILE</span>';
</div><div class="hljs-line">
</div><div class="hljs-line"># 记录于表表中
</div><div class="hljs-line"><span class="hljs-selector-tag">SET</span> @@<span class="hljs-keyword">global</span>.<span class="hljs-keyword">log_output</span>='<span class="hljs-keyword">TABLE</span>';
</div><div class="hljs-line">
</div><div class="hljs-line"># 记录于文件和表中
</div><div class="hljs-line"><span class="hljs-selector-tag">SET</span> @@<span class="hljs-keyword">global</span>.<span class="hljs-keyword">log_output</span>='<span class="hljs-keyword">TABLE</span>,<span class="hljs-keyword">FILE</span>';
</div></code></pre>

<ol start="3"><li rel="3">开启慢速查询日志</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs lasso"><div class="hljs-line"><span class="hljs-built_in">SET</span> @@<span class="hljs-built_in">global</span>.log_slow_queries=<span class="hljs-keyword">ON</span>
</div><div class="hljs-line"><span class="hljs-built_in">SET</span> @@<span class="hljs-built_in">global</span>.slow_query_log=<span class="hljs-keyword">ON</span>
</div></code></pre>

<ol start="4"><li rel="4">查看慢速查询日志存储路径</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs autoit"><div class="hljs-line"><span class="hljs-keyword">select</span> @<span class="hljs-symbol">@slow_query_log_file</span><span class="hljs-comment">;</span>
</div></code></pre>

<ol start="5"><li rel="5">查看表中的慢速查询日志</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs sql"><div class="hljs-line"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> mysql.slow_log;
</div></code></pre>

<p><font size="4" color="#ff5809"> <br>
错误日志 <br>
</font> <br>
错误日志主要记录以下几类信息：</p>

<ul><li>mysqld启动或关闭过程中的输出信息</li>
<li>mysqld运行中产生的错误信息</li>
<li>event scheduler 运行时产生的信息</li>
<li><p>主从复制架构中，从服务器启动复制线程产生的信息</p>

<ol>
<li rel="1">查看错误日志的存储位置</li></ol></li>
</ul>



<pre class="prettyprint hljs-dark"><code class="hljs css"><div class="hljs-line"><span class="hljs-selector-tag">MariaDB</span>&gt; <span class="hljs-selector-tag">set</span> @@<span class="hljs-keyword">global</span>.<span class="hljs-keyword">log_error</span>=<span class="hljs-keyword">OFF</span>;
</div></code></pre>

<ol start="2"><li rel="2">警告日志的开启与关闭</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs css"><div class="hljs-line"> <span class="hljs-selector-tag">SET</span> @@<span class="hljs-keyword">global</span>.<span class="hljs-keyword">log_warnings</span>=<span class="hljs-keyword">0</span>|<span class="hljs-keyword">1</span>
</div></code></pre>

<p><font size="4" color="#ff5809"> <br>
二进制日志 <br>
</font> <br>
二进制日志记录了引起数据库数据改变的SQL语句，不包括SELEC和SHOW语句</p>

<p>二进制日志主要有以下几种作用</p>

<ul><li>恢复 (recovery) ： 数据库恢复一般都需要二进制日志做最后系统崩溃前 point-in-time 的恢复，比如数据库做了完整恢复和增量恢复后仍然有数据库崩溃前到最近一次增量备份时间段内的数据未恢复，此时就需要使用二进制日志来恢复。</li>
<li>复制 (replication) ：复制和恢复的原理一样，在主从数据库服务器的架构中，从服务器需要从主服务器上复制二进制日志文件到从服务器上，存储为中继日志后，再同步到从服务器上，从而实现主从异步同步数据的目的。</li>
<li>审计 (audit) : 可以通过分析二进制日志中的信息，判断是否有对数据库进行入驻攻击。</li>
</ul>

<hr>

<ol start="1"><li rel="1">二进制日志记录的格式</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs mel"><div class="hljs-line"><span class="hljs-keyword">select</span> @@<span class="hljs-keyword">global</span>.binlog_format;
</div><div class="hljs-line">
</div><div class="hljs-line">set @@<span class="hljs-keyword">global</span>.binlog_format={ROW|STATEMENT|MIXED}
</div></code></pre>

<ol start="2"><li rel="2">查看二进制日志文件列表</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs asciidoc"><div class="hljs-line">MariaDB&gt; show binary logs; 
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-section">MariaDB&gt; show master logs;
</span></div><div class="hljs-line">+----------------+-----------+
</div><div class="hljs-line"><span class="hljs-section">| Log_name       | File_size |
</span></div><div class="hljs-line">+----------------+-----------+
</div><div class="hljs-line">| log-bin.000001 | 30331     |
</div><div class="hljs-line">| log-bin.000002 | 1038814   |
</div><div class="hljs-line">| log-bin.000003 | 286       |
</div><div class="hljs-line">| log-bin.000004 | 493       |
</div><div class="hljs-line">| log-bin.000005 | 561       |
</div><div class="hljs-line">| log-bin.000006 | 264       |
</div><div class="hljs-line">| log-bin.000007 | 264       |
</div><div class="hljs-line"><span class="hljs-section">| log-bin.000008 | 245       |
</span></div><div class="hljs-line">+----------------+-----------+
</div></code></pre>

<ol start="3"><li rel="3">滚动二进制日志文件，从启一个文件记录二进制日志文件</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs abnf"><div class="hljs-line">MariaDB&gt; flush logs<span class="hljs-comment">;</span>
</div></code></pre>

<ol start="4"><li rel="4">查看当前使用的二进制日志文件</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs asciidoc"><div class="hljs-line"><span class="hljs-section">MariaDB&gt; show master status;
</span></div><div class="hljs-line">+----------------+----------+--------------+------------------+
</div><div class="hljs-line"><span class="hljs-section">| File           | Position | Binlog_Do_DB | Binlog_Ignore_DB |
</span></div><div class="hljs-line">+----------------+----------+--------------+------------------+
</div><div class="hljs-line"><span class="hljs-section">| log-bin.000009 | 245      |              |                  |
</span></div><div class="hljs-line">+----------------+----------+--------------+------------------+
</div></code></pre>

<ol start="4"><li rel="4">查看二进制日志文件中的事件信息</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs asciidoc"><div class="hljs-line"><span class="hljs-section">show binlog events in 'log-bin.000001' from 321 limit 1 \G;
</span></div><div class="hljs-line">---
</div><div class="hljs-line"><span class="hljs-emphasis">'log-bin.000001'</span> : 文件名
</div><div class="hljs-line">from 321 ： 从哪个字节开始读取
</div><div class="hljs-line">limit : 读取的行数
</div></code></pre>

<ol start="5"><li rel="5">设定配置文件启动二进制日志文件</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs makefile"><div class="hljs-line">vim /etc/my.cnf.d/server.cnf
</div><div class="hljs-line">[server]
</div><div class="hljs-line"><span class="hljs-comment"># 不解析名字</span>
</div><div class="hljs-line">skip_name_resolve=ON  
</div><div class="hljs-line"><span class="hljs-comment"># InnoDB引擎的每个表单独存储于一个文件中</span>
</div><div class="hljs-line">innodb_file_per_table=ON
</div><div class="hljs-line"><span class="hljs-comment"># 连接数</span>
</div><div class="hljs-line">max_connections=10000
</div><div class="hljs-line"><span class="hljs-comment"># 服务器编号</span>
</div><div class="hljs-line">server_id=10
</div><div class="hljs-line"><span class="hljs-comment"># 二进制日志文件存储路径</span>
</div><div class="hljs-line">log_bin=log-bin
</div></code></pre>

<ol start="6"><li rel="6">查看二进制日志文件的最大字节数</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs asciidoc"><div class="hljs-line"><span class="hljs-section">MariaDB&gt; select @@max_binlog_size;
</span></div><div class="hljs-line">+-------------------+
</div><div class="hljs-line"><span class="hljs-section">| @@max_binlog_size |
</span></div><div class="hljs-line">+-------------------+
</div><div class="hljs-line"><span class="hljs-section">| 1073741824        |
</span></div><div class="hljs-line">+-------------------+
</div></code></pre>

<ol start="7"><li rel="7">控制写操作是否会记录与二进制日志文件中，进行二进制日志的恢复时，关闭，操作完后启动</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs css"><div class="hljs-line"><span class="hljs-selector-tag">select</span> @@<span class="hljs-keyword">session</span>.<span class="hljs-keyword">sql_log_bin</span>;
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-selector-tag">set</span> @@<span class="hljs-keyword">session</span>.<span class="hljs-keyword">sql_log_bin</span>=<span class="hljs-keyword">0</span>|<span class="hljs-keyword">1</span>;
</div></code></pre>

<ol start="8"><li rel="8">控制一旦事务提交立即将内存的日志同步到磁盘，启用则保证了数据的安全，但会影响性能</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs css"><div class="hljs-line"><span class="hljs-selector-tag">select</span> @@<span class="hljs-keyword">sync_binlog</span>;
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-selector-tag">set</span> @@<span class="hljs-keyword">sync_binlog</span>=<span class="hljs-keyword">0</span>|<span class="hljs-keyword">1</span>;
</div></code></pre>

<ol start="9"><li rel="9">使用 <code>mysqlbinlog</code> 查看二进制日志文件</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs crystal"><div class="hljs-line">mysqlbinlog [options] FILE_NAME
</div><div class="hljs-line">---
</div><div class="hljs-line">[options]
</div><div class="hljs-line">    --start-datetime=<span class="hljs-string">"YYYY-MM-DD hh:mm:ss"</span>
</div><div class="hljs-line">    --stop-datetime=<span class="hljs-string">"YYYY-MM-DD hh:mm:ss"</span>
</div><div class="hljs-line">    -j, --start-position=NUM
</div><div class="hljs-line">    --stop-position=NUM
</div><div class="hljs-line">    --user USER
</div><div class="hljs-line">    --host HOST
</div><div class="hljs-line">    --password PASSWORD
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-comment"># example</span>
</div><div class="hljs-line">mysqlbinlog  --start-date=<span class="hljs-string">"2017-11-10 22:46:50"</span> /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">mysql</span>/<span class="hljs-title">log</span>-<span class="hljs-title">bin</span>.000009;</span>
</div><div class="hljs-line"> mysqlbinlog  --start-position=<span class="hljs-number">316</span> --stop-position=<span class="hljs-number">444</span> /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">mysql</span>/<span class="hljs-title">log</span>-<span class="hljs-title">bin</span>.000009;</span>
</div></code></pre>

<ol start="10"><li rel="10">二进制日志格式</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs cs"><div class="hljs-line"><span class="hljs-meta"># at 316</span>
</div><div class="hljs-line"><span class="hljs-meta">#171110 22:46:50 server id 10  end_log_pos 444  Query   thread_id=7 exec_time=0 error_code=0</span>
</div><div class="hljs-line">use `courses`<span class="hljs-comment">/*!*/</span>;
</div><div class="hljs-line">SET TIMESTAMP=<span class="hljs-number">1510325210</span><span class="hljs-comment">/*!*/</span>;
</div><div class="hljs-line"><span class="hljs-function">insert <span class="hljs-keyword">into</span> <span class="hljs-title">students</span>(<span class="hljs-params">id,name,major</span>) <span class="hljs-title">values</span>(<span class="hljs-params"><span class="hljs-number">2</span>,<span class="hljs-string">'Moretz'</span>,<span class="hljs-string">'Music'</span></span>)
</span></div><div class="hljs-line"><span class="hljs-comment">/*!*/</span>;
</div><div class="hljs-line">
</div><div class="hljs-line">事件的起始位置：<span class="hljs-meta"># at 316</span>
</div><div class="hljs-line">事件发生的日期时间：<span class="hljs-meta">#171110 22:46:50</span>
</div><div class="hljs-line">事件发生的服务器: server id <span class="hljs-number">10</span>
</div><div class="hljs-line">事件的结束位置：server id <span class="hljs-number">10</span>
</div><div class="hljs-line">事件的类型：Query
</div><div class="hljs-line">事件发生时所在服务器执行此事件的连接线程的ID：thread_id=<span class="hljs-number">7</span>
</div><div class="hljs-line">语句的时间戳与将其写入二进制日志文件中的时间差，小于<span class="hljs-number">1</span>s的为<span class="hljs-number">0</span>：exec_time=<span class="hljs-number">0</span>
</div><div class="hljs-line">错误代码，正确为<span class="hljs-number">0</span>：error_code=<span class="hljs-number">0</span>
</div><div class="hljs-line">设定事件发生时的时间戳：语句的时间戳与将其写入二进制日志文件中的时间差：exec_time=<span class="hljs-number">0</span>
</div><div class="hljs-line">    --小于<span class="hljs-number">1</span>s都是为<span class="hljs-number">0</span>
</div><div class="hljs-line">错误代码：error_code=<span class="hljs-number">0</span>
</div><div class="hljs-line">设定事件发生时的时间戳：SET TIMESTAMP=<span class="hljs-number">1472608568</span><span class="hljs-comment">/*!*/</span>;
</div><div class="hljs-line">事件内容：<span class="hljs-function">insert <span class="hljs-keyword">into</span> <span class="hljs-title">students</span>(<span class="hljs-params">id,name,major</span>) <span class="hljs-title">values</span>(<span class="hljs-params"><span class="hljs-number">2</span>,<span class="hljs-string">'Moretz'</span>,<span class="hljs-string">'Music'</span></span>)</span>
</div></code></pre>

<p><font size="4" color="#ff5809"> <br>
中继日志 <br>
</font> <br>
从服务器记录从主服务器上复制二进制日志文件的事件日志</p>

<p><font size="4" color="#ff5809"> <br>
事务日志 <br>
</font> <br>
事务存储引擎InnoDB用于保证事务特性的日志文件</p>

<p><font size="5" color="#0099ff"> <br>
MySQL 备份</font> <br>
<font size="4" color="#ff5809"> <br>
备份类型 <br>
</font> <br>
MySQL备份类型从不同的角度有不同的划分</p>

<ol><li rel="1"><p>按照备份时数据服务是否在线</p>

<ul>
<li>热备 (Hot Backup / Online Backup)</li>
<li>温备 (Warm Backup)</li>
<li>冷备 (Cold Backup / Offline Backup)</li></ul></li>
<li rel="2"><p>按照备份的数据范围</p>

<ul>
<li>完全备份 ： 所有数据库</li>
<li>部分备份 ： 数据库的一部分，比如某个表</li></ul></li>
<li rel="3"><p>按照备份的时间范围</p>

<ul>
<li>全量备份</li>
<li>增量备份</li>
<li>差异备份</li></ul></li>
<li rel="4"><p>按照备份后的数据类型</p>

<ul>
<li>逻辑备份</li>
<li>物理备份或裸备</li></ul></li>
</ol>

<p><font size="4" color="#ff5809"> <br>
备份工具 <br>
</font></p>



<pre class="prettyprint hljs-dark"><code class="hljs avrasm"><div class="hljs-line"><span class="hljs-number">1.</span> mysqldump <span class="hljs-meta"># mysql 自带的备份工具，对InnoDB实现逻辑、热备，支持全量备份，MyISAM温备</span>
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-number">2.</span> <span class="hljs-keyword">cp</span>/tar <span class="hljs-meta"># 使用逻辑卷达到几乎热备的效果，属于物理备份</span>
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-number">3.</span> xtrabackup <span class="hljs-meta"># Percona 提供的开源、免费的备份工具，支持对InnoDB实现物理、热备，并且支持全量备份，增量备份或差异备份</span>
</div></code></pre>

<p><font size="4" color="#ff5809"> <br>
使用 mysqldump 实现备份 <br>
</font> <br>
<strong>mysqldump 命令</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs haml"><div class="hljs-line"># mysqldump 命令语法
</div><div class="hljs-line"># 1. 备份指定库中的指定表
</div><div class="hljs-line">shell&gt; mysqldump [options] db_name [tbl_name ...]
</div><div class="hljs-line"># 2. 备份指定的数据库
</div><div class="hljs-line">shell&gt; mysqldump [options] --databases db_name ...
</div><div class="hljs-line"># 3. 备份所有数据库
</div><div class="hljs-line">shell&gt; mysqldump [options] --all-databases
</div><div class="hljs-line">
</div><div class="hljs-line">-<span class="ruby">--
</span></div><div class="hljs-line">[options]
</div><div class="hljs-line">    -<span class="ruby">l <span class="hljs-params">| --lock-tables #备份时锁住每个架构下面的所有表，用户备份MyISAM时使用，备份InnoDB时使用 --single-transaction, 并且--lock-tables和--single-transaction是互斥的，只能使用其中的一种，对于架构下面即有MyISAM也有InnoDB，只能使用--locak-tables了。使用--lock-tables只能保证每个架构下面的表一致性，不能保证所有表一致性。锁住的情况下可以继续读，但不能执行写操作
</span></span></div><div class="hljs-line">    -<span class="ruby"><span class="hljs-params">x |</span> --lock-all-tables <span class="hljs-comment">#备份时锁住所有表，保证了所有表的一致性，但备份时间过长的话会影响业务。</span>
</span></div><div class="hljs-line">    -<span class="ruby">single-transaction <span class="hljs-comment">#使用于InnoDB进行热备，备份开始时开启一个长长的事务(start transaction)以保证数据的一致性。</span>
</span></div><div class="hljs-line">    -<span class="ruby">-master-data=<span class="hljs-number">1</span><span class="hljs-params">|2 # 等于2时，CHANGE MASTER TO 语句被注释
</span></span></div><div class="hljs-line">    -<span class="ruby"><span class="hljs-params">E |</span> --events <span class="hljs-comment">#备份事件调度器</span>
</span></div><div class="hljs-line">    -<span class="ruby">R <span class="hljs-params">| --routines #备份程序或函数
</span></span></div><div class="hljs-line">    -<span class="ruby"><span class="hljs-params">-triggers #备份触发器</span></span>
</div></code></pre>

<p><strong>备份策略</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs"><div class="hljs-line">全量备份+binlog
</div></code></pre>

<p><strong>第一步： 开启二进制日志，并设定相应参数</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs stata"><div class="hljs-line"># 创建数据库备份目录和二进制日志存储目录
</div><div class="hljs-line">[node1@root ~]# <span class="hljs-keyword">mkdir</span> -p /<span class="hljs-keyword">app</span>/data/<span class="hljs-keyword">log</span> 
</div><div class="hljs-line">[node1@root ~]# chown mysql:mysql /<span class="hljs-keyword">app</span>/data/<span class="hljs-built_in">log</span>
</div><div class="hljs-line">
</div><div class="hljs-line">vim /etc/my.cnf.<span class="hljs-keyword">d</span>/server.cnf
</div><div class="hljs-line">[server]
</div><div class="hljs-line">skip_name_resolve=<span class="hljs-keyword">ON</span>
</div><div class="hljs-line">innodb_file_per_table=<span class="hljs-keyword">ON</span>
</div><div class="hljs-line">max_connections=10000
</div><div class="hljs-line">server_id=1
</div><div class="hljs-line">log_bin=/<span class="hljs-keyword">app</span>/data/<span class="hljs-keyword">log</span>/<span class="hljs-keyword">log</span>-bin #设定二进制日志路径及前缀名
</div></code></pre>

<p><strong>第二步 ： 准备备份测试环境</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs lsl"><div class="hljs-line"># <span class="hljs-number">1.</span> 创建用户bkuser, 用做备份数据库用户
</div><div class="hljs-line">MariaDB&gt; grant all on *.* to 'bkuser'@'<span class="hljs-number">172.18</span><span class="hljs-number">.17</span>.%' identified by '<span class="hljs-number">123</span>';
</div><div class="hljs-line">MariaDB&gt; flush privileges;
</div><div class="hljs-line">
</div><div class="hljs-line"># <span class="hljs-number">2.</span> 创建测试数据库和表
</div><div class="hljs-line">MariaDB&gt; create database courses;
</div><div class="hljs-line">MariaDB&gt; use courses;
</div><div class="hljs-line">MariaDB&gt; create table students(id int primary <span class="hljs-type">key</span>, name char(<span class="hljs-number">20</span>) not null, major varchar(<span class="hljs-number">200</span>));
</div><div class="hljs-line">
</div><div class="hljs-line"># <span class="hljs-number">3.</span> 向表中插入数据
</div><div class="hljs-line">[node1@root mysql]# for i in {<span class="hljs-number">1.</span><span class="hljs-number">.100</span>};do mysql -ubkuser -p123 -h172<span class="hljs-number">.18</span><span class="hljs-number">.17</span><span class="hljs-number">.21</span> -e <span class="hljs-string">"insert into courses.students(id,name) values($i,'stu$i');"</span>;done
</div></code></pre>

<p><strong>第三步：备份数据</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs crystal"><div class="hljs-line"><span class="hljs-comment"># 备份</span>
</div><div class="hljs-line">[<span class="hljs-number">20</span>@root ~]<span class="hljs-comment">#  mysqldump -h172.18.17.21 -ubkuser -p123 --all-databases --single-transaction -E -R --triggers --master-data=2 -F &gt; /app/data/all-backup_$(date +%F-%H-%M-%S).sql</span>
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-comment"># 修改数据</span>
</div><div class="hljs-line">MariaDB&gt; delete from courses.students where id between <span class="hljs-number">1</span> and <span class="hljs-number">20</span>;
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-comment"># 模拟数据库崩溃</span>
</div><div class="hljs-line">rm /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">mysql</span>/* -<span class="hljs-title">rf</span></span>
</div></code></pre>

<p><strong>第四步： 还原数据库</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs autoit"><div class="hljs-line"><span class="hljs-meta"># 查看最近一次全量备份数据库中记录的二进制日志文件名，和位置</span>
</div><div class="hljs-line">vim /app/data/all-backup_2017<span class="hljs-number">-11</span><span class="hljs-number">-11</span><span class="hljs-number">-16</span><span class="hljs-number">-14</span><span class="hljs-number">-43.</span>sql 
</div><div class="hljs-line">-- CHANGE MASTER <span class="hljs-keyword">TO</span> MASTER_LOG_FILE=<span class="hljs-string">'log-bin.000004'</span>, MASTER_LOG_POS=<span class="hljs-number">245</span><span class="hljs-comment">;</span>
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-meta"># 将备份和相应二进制日志拷贝到另外一个目录下，防止二次破坏影响还原</span>
</div><div class="hljs-line">[node1<span class="hljs-symbol">@root</span> ~]<span class="hljs-meta"># mkdir /app/bakup</span>
</div><div class="hljs-line">[node1<span class="hljs-symbol">@root</span> ~]<span class="hljs-meta"># cp -r /app/data/* /app/bakup/</span>
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-meta"># 还原全量备份</span>
</div><div class="hljs-line"><span class="hljs-meta"># 关闭二进制日志记录，还原数据库的过程中，我们不希望记录日志</span>
</div><div class="hljs-line">MariaDB&gt; set @<span class="hljs-symbol">@session</span>.sql_log_bin=OFF<span class="hljs-comment">;</span>
</div><div class="hljs-line"><span class="hljs-meta"># 还原</span>
</div><div class="hljs-line">[node1<span class="hljs-symbol">@root</span> ~]<span class="hljs-meta"># mysql &lt; /app/bakup/all-backup_2017-11-11-16-14-43.sql </span>
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-meta"># 重放二进制日志完成系统崩溃前的数据还原</span>
</div><div class="hljs-line">mysqlbinlog --start-position <span class="hljs-number">245</span> /app/bakup/<span class="hljs-built_in">log</span>/<span class="hljs-built_in">log</span>-bin<span class="hljs-number">.000004</span> &gt; /app/bakup/bin-<span class="hljs-built_in">log</span>.sql
</div><div class="hljs-line">mysql &lt; /app/bakup/bin-<span class="hljs-built_in">log</span>.sql 
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-meta"># 开启二进制日志记录功能</span>
</div><div class="hljs-line">MariaDB&gt; set @<span class="hljs-symbol">@session</span>.sql_log_bin=ON<span class="hljs-comment">;</span>
</div></code></pre>

<p><strong>第五步： 做一次全量备份</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs brainfuck"><div class="hljs-line"><span class="hljs-title">[</span><span class="hljs-comment">node1@root</span> <span class="hljs-comment">~</span><span class="hljs-title">]</span><span class="hljs-comment">#</span> <span class="hljs-comment">mysqldump</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">all</span><span class="hljs-literal">-</span><span class="hljs-comment">databases</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">single</span><span class="hljs-literal">-</span><span class="hljs-comment">transaction</span> <span class="hljs-literal">-</span><span class="hljs-comment">F</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">master</span><span class="hljs-literal">-</span><span class="hljs-comment">data=2</span> <span class="hljs-literal">-</span><span class="hljs-comment">R</span> <span class="hljs-literal">-</span><span class="hljs-comment">E</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">triggers</span> &gt; <span class="hljs-comment">/app/data/all</span><span class="hljs-literal">-</span><span class="hljs-comment">bakup_$(date</span> <span class="hljs-literal">+</span><span class="hljs-comment">"%F</span><span class="hljs-literal">-</span><span class="hljs-comment">%H</span><span class="hljs-literal">-</span><span class="hljs-comment">%M</span><span class="hljs-literal">-</span><span class="hljs-comment">%S")</span><span class="hljs-string">.</span><span class="hljs-comment">sql</span>
</div></code></pre>

<p><em>备份脚本</em></p>

<ol start="1"><li rel="1">备份脚本</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs perl"><div class="hljs-line">[node1@root scritps]<span class="hljs-comment"># cat mysql_backup.sh </span>
</div><div class="hljs-line"><span class="hljs-comment">#/bin/bash</span>
</div><div class="hljs-line">
</div><div class="hljs-line">user=<span class="hljs-string">"bkuser"</span>
</div><div class="hljs-line">password=<span class="hljs-string">"123"</span>
</div><div class="hljs-line">host=<span class="hljs-string">"172.18.17.21"</span>
</div><div class="hljs-line">
</div><div class="hljs-line">data_bk_dir=<span class="hljs-string">"/app/data"</span>
</div><div class="hljs-line">binlog_bk_dir=<span class="hljs-string">"/app/data/log"</span>
</div><div class="hljs-line">cnf_bk_dir=<span class="hljs-regexp">/app/data</span><span class="hljs-regexp">/cnf/</span>$(date +<span class="hljs-string">"%F-%H-%M-%S"</span>)
</div><div class="hljs-line">
</div><div class="hljs-line">[ -d <span class="hljs-string">"$binlog_bk_dir"</span> ] ||     <span class="hljs-keyword">mkdir</span> -p <span class="hljs-string">"$binlog_bk_dir"</span>
</div><div class="hljs-line">[ -d <span class="hljs-string">"$cnf_bk_dir"</span> ] || <span class="hljs-keyword">mkdir</span> -p <span class="hljs-string">"$cnf_bk_dir"</span>
</div><div class="hljs-line">
</div><div class="hljs-line">/usr/bin/<span class="hljs-keyword">chown</span> mysql:mysql <span class="hljs-string">"$binlog_bk_dir"</span>
</div><div class="hljs-line">
</div><div class="hljs-line">/usr/bin/mysqldump -u ${user} -p${password} -h ${host} --all-databases --single-transaction -F --master-data=<span class="hljs-number">2</span> -R -E --triggers &gt; ${data_bk_dir}/all-bakup<span class="hljs-number">_</span>$(date +<span class="hljs-string">"%F-%H-%M-%S"</span>).sql
</div><div class="hljs-line">
</div><div class="hljs-line">cp -ar /etc/my.cnf* ${cnf_bk_dir}
</div></code></pre>

<ol start="2"><li rel="2">添加到计划任务，根据需求制定任务计划，这里假设每周做一次全量备份，时间为每周六03:00进行备份</li>
</ol>



<pre class="prettyprint hljs-dark"><code class="hljs awk"><div class="hljs-line">vim <span class="hljs-regexp">/etc/</span>crontab
</div><div class="hljs-line"><span class="hljs-number">0</span> <span class="hljs-number">3</span> * * <span class="hljs-number">6</span> root <span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/bash /</span>app<span class="hljs-regexp">/scripts/my</span>sql_backup.sh
</div></code></pre>

<p><font size="4" color="#ff5809"> <br>
使用 xtrabackup 实现备份 <br>
</font></p>

<p><strong>下载安装percona-xtrabackup</strong> <br>
<a href="https://www.percona.com/downloads/XtraBackup/LATEST/" target="_blank">percona-xtrabackup 下载地址</a></p>



<pre class="prettyprint hljs-dark"><code class="hljs css"><div class="hljs-line"><span class="hljs-selector-tag">yum</span> <span class="hljs-selector-tag">-y</span> <span class="hljs-selector-tag">install</span> <span class="hljs-selector-tag">percona-xtrabackup-24-2</span><span class="hljs-selector-class">.4</span><span class="hljs-selector-class">.8-1</span><span class="hljs-selector-class">.el7</span><span class="hljs-selector-class">.x86_64</span><span class="hljs-selector-class">.rpm</span>
</div></code></pre>

<hr>

<p><strong><em>全量+binlog</em></strong></p>

<p><strong>第一步： 实验环境</strong> <br>
实验环境和上面一个一样</p>



<pre class="prettyprint hljs-dark"><code class="hljs livescript"><div class="hljs-line"><span class="hljs-comment"># 1. 创建存储备份文件和二进制日志文件的目录</span>
</div><div class="hljs-line">[node1@root ~]<span class="hljs-comment"># mkdir /app/data/{log,all,increment}</span>
</div><div class="hljs-line">[node1@root ~]<span class="hljs-comment"># chown mysql:mysql /app/data/log</span>
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-comment"># 2. mysql配置文件</span>
</div><div class="hljs-line">vim /etc/my.cnf.d/server.cnf
</div><div class="hljs-line">    [server]
</div><div class="hljs-line">    skip_name_resolve=ON
</div><div class="hljs-line">    innodb_file_per_table=ON
</div><div class="hljs-line">    max_connections=<span class="hljs-number">10000</span>
</div><div class="hljs-line">    server_id=<span class="hljs-number">1</span>
</div><div class="hljs-line">    log_bin=/app/data/log/log-bin
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-comment"># 3. 启动mariadb</span>
</div><div class="hljs-line"> systemctl start mariadb
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-comment"># 4. 创建备份用户</span>
</div><div class="hljs-line">MariaDB&gt;  grant all <span class="hljs-literal">on</span> *.* <span class="hljs-keyword">to</span> <span class="hljs-string">'bkuser'</span>@<span class="hljs-string">'172.18.17.%'</span> identified <span class="hljs-keyword">by</span> <span class="hljs-string">'123'</span>;
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-comment"># 5. 创建数据库和表</span>
</div><div class="hljs-line">MariaDB&gt; create database courses;
</div><div class="hljs-line">MariaDB&gt; create table courses.students(id int primary key, name char(<span class="hljs-number">20</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>, major varchar(<span class="hljs-number">200</span>));
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-comment"># 6. 插入数据</span>
</div><div class="hljs-line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> {<span class="hljs-number">1.</span>.<span class="hljs-number">100</span>};<span class="hljs-keyword">do</span> mysql -ubkuser -p123 -h172.<span class="hljs-number">18.17</span>.<span class="hljs-number">21</span> -e <span class="hljs-string">"insert into courses.students(id,name) values($i,'stu$i');"</span>;done
</div></code></pre>

<p><strong>第二步：全量备份</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs lsl"><div class="hljs-line"># 全量备份
</div><div class="hljs-line">innobackupex -ubkuser -p123 -H172<span class="hljs-number">.18</span><span class="hljs-number">.17</span><span class="hljs-number">.21</span> /app/data/all/
</div><div class="hljs-line">
</div><div class="hljs-line"># 查看备份的LSN信息
</div><div class="hljs-line">cat /app/data/all/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_20<span class="hljs-number">-31</span><span class="hljs-number">-48</span>/xtrabackup_checkpoints 
</div><div class="hljs-line">backup_type = full-backuped
</div><div class="hljs-line">from_lsn = <span class="hljs-number">0</span>
</div><div class="hljs-line">to_lsn = <span class="hljs-number">1707853</span>
</div><div class="hljs-line">last_lsn = <span class="hljs-number">1707853</span>
</div><div class="hljs-line">compact = <span class="hljs-number">0</span>
</div><div class="hljs-line">recover_binlog_info = <span class="hljs-number">0</span>=
</div><div class="hljs-line">
</div><div class="hljs-line"># 查看备份的日志位置
</div><div class="hljs-line">cat /app/data/all/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_20<span class="hljs-number">-31</span><span class="hljs-number">-48</span>/xtrabackup_binlog_pos_innodb 
</div><div class="hljs-line">/app/data/log/log-bin<span class="hljs-number">.000003</span>    <span class="hljs-number">21207</span>
</div></code></pre>

<p><strong>第三步： 修改数据，并模拟系统崩溃</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs applescript"><div class="hljs-line"><span class="hljs-comment"># 修改数据</span>
</div><div class="hljs-line">delete <span class="hljs-keyword">from</span>  courses.students <span class="hljs-keyword">where</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">between</span> <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">50</span>；
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-comment"># 删除数据库，模拟系统崩溃</span>
</div><div class="hljs-line">[node1@root ~]<span class="hljs-comment"># systemctl stop mariadb</span>
</div><div class="hljs-line">[node1@root ~]<span class="hljs-comment"># rm /var/lib/mysql/* -rf</span>
</div></code></pre>

<p><strong>第四步：恢复</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs crystal"><div class="hljs-line"><span class="hljs-comment"># 使用xtrabackup 恢复全量数据</span>
</div><div class="hljs-line"><span class="hljs-comment"># 1. 执行 preparing 操作</span>
</div><div class="hljs-line">innobackupex --apply-log /app/data/all/<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">11_20</span>-<span class="hljs-number">31</span>-<span class="hljs-number">48</span>/
</div><div class="hljs-line"><span class="hljs-comment"># 2. 恢复数据库</span>
</div><div class="hljs-line">innobackupex --copy-back /app/data/all/<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">11_20</span>-<span class="hljs-number">31</span>-<span class="hljs-number">48</span>/
</div><div class="hljs-line"><span class="hljs-comment"># 3. 修改属主属组</span>
</div><div class="hljs-line">chown -R <span class="hljs-symbol">mysql:</span>mysql /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">mysql</span></span>
</div></code></pre>

<p><strong>第五步：使用二进制日志完成最后崩溃前的恢复</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs fortran"><div class="hljs-line"># <span class="hljs-number">1.</span> 复制二进制文件到指定位置备用
</div><div class="hljs-line">cp  /app/<span class="hljs-keyword">data</span>/<span class="hljs-built_in">log</span>/<span class="hljs-built_in">log</span>-bin<span class="hljs-number">.000003</span> /app/<span class="hljs-keyword">data</span>/
</div><div class="hljs-line"># <span class="hljs-number">5.</span> 启动数据库，并设置不记录二进制日志
</div><div class="hljs-line">MariaDB&gt; set @@session.sql_log_bin=<span class="hljs-number">0</span>;
</div><div class="hljs-line">
</div><div class="hljs-line"># <span class="hljs-number">6.</span> 恢复
</div><div class="hljs-line">mysqlbinlog --start-<span class="hljs-keyword">position</span> <span class="hljs-number">21207</span> /app/<span class="hljs-keyword">data</span>/<span class="hljs-built_in">log</span>-bin<span class="hljs-number">.000003</span> &gt; /app/<span class="hljs-keyword">data</span>/<span class="hljs-built_in">log</span>-bin.sql
</div><div class="hljs-line">mysql &lt; /app/<span class="hljs-keyword">data</span>/<span class="hljs-built_in">log</span>-bin.sql
</div></code></pre>

<p><strong>第六步：启用数据前做一次全量备份后方可继续使用</strong></p>

<hr>

<p><strong><em>全量+增量+binlog</em></strong> <br>
<strong>第一步：在上一个 “全量+binlog” 的基础上演示该实验</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs gherkin"><div class="hljs-line">MariaDB&gt; select <span class="hljs-symbol">*</span> from courses.students;
</div><div class="hljs-line">+----+-------+-------+
</div><div class="hljs-line">|<span class="hljs-string"> id </span>|<span class="hljs-string"> name  </span>|<span class="hljs-string"> major </span>|
</div><div class="hljs-line">+----+-------+-------+
</div><div class="hljs-line">|<span class="hljs-string"> 51 </span>|<span class="hljs-string"> stu51 </span>|<span class="hljs-string"> NULL  </span>|
</div><div class="hljs-line">|<span class="hljs-string"> 52 </span>|<span class="hljs-string"> stu52 </span>|<span class="hljs-string"> NULL  </span>|
</div><div class="hljs-line">|<span class="hljs-string"> 53 </span>|<span class="hljs-string"> stu53 </span>|<span class="hljs-string"> NULL  </span>|
</div><div class="hljs-line">|<span class="hljs-string"> 54 </span>|<span class="hljs-string"> stu54 </span>|<span class="hljs-string"> NULL  </span>|
</div><div class="hljs-line">|<span class="hljs-string"> 55 </span>|<span class="hljs-string"> stu55 </span>|<span class="hljs-string"> NULL  </span>|
</div><div class="hljs-line">|<span class="hljs-string"> 56 </span>|<span class="hljs-string"> stu56 </span>|<span class="hljs-string"> NULL  </span>|
</div><div class="hljs-line">|<span class="hljs-string"> 57 </span>|<span class="hljs-string"> stu57 </span>|<span class="hljs-string"> NULL  </span>|
</div><div class="hljs-line">|<span class="hljs-string"> 58 </span>|<span class="hljs-string"> stu58 </span>|<span class="hljs-string"> NULL  </span>|
</div><div class="hljs-line">|<span class="hljs-string"> 59 </span>|<span class="hljs-string"> stu59 </span>|<span class="hljs-string"> NULL  </span>|
</div><div class="hljs-line">|<span class="hljs-string"> 60 </span>|<span class="hljs-string"> stu60 </span>|<span class="hljs-string"> NULL  </span>|
</div><div class="hljs-line">+----+-------+-------+
</div></code></pre>

<p><strong>第二步：全量备份</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs lsl"><div class="hljs-line">innobackupex -ubkuser -p123 -H172<span class="hljs-number">.18</span><span class="hljs-number">.17</span><span class="hljs-number">.21</span> /app/data/all/
</div><div class="hljs-line">
</div><div class="hljs-line"># 查看全量备份的LSN编号
</div><div class="hljs-line">cat /app/data/all/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_21<span class="hljs-number">-14</span><span class="hljs-number">-54</span>/xtrabackup_
</div><div class="hljs-line">xtrabackup_binlog_info  xtrabackup_checkpoints  xtrabackup_info         xtrabackup_logfile      
</div><div class="hljs-line">[node1@root ~]# cat /app/data/all/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_21<span class="hljs-number">-14</span><span class="hljs-number">-54</span>/xtrabackup_checkpoints 
</div><div class="hljs-line">backup_type = full-backuped
</div><div class="hljs-line">from_lsn = <span class="hljs-number">0</span>
</div><div class="hljs-line">to_lsn = <span class="hljs-number">1719643</span>
</div><div class="hljs-line">last_lsn = <span class="hljs-number">1719643</span>
</div><div class="hljs-line">compact = <span class="hljs-number">0</span>
</div><div class="hljs-line">recover_binlog_info = <span class="hljs-number">0</span>
</div></code></pre>

<p><strong>第三步： 第一次增量备份</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs lsl"><div class="hljs-line"># 修改数据
</div><div class="hljs-line">MariaDB&gt; update courses.students set major=<span class="hljs-string">"Engish"</span> where id between <span class="hljs-number">51</span> and <span class="hljs-number">55</span>;
</div><div class="hljs-line">
</div><div class="hljs-line"># 增量备份
</div><div class="hljs-line">[node1@root ~]# innobackupex -ubkuser -p123 -H172<span class="hljs-number">.18</span><span class="hljs-number">.17</span><span class="hljs-number">.21</span> --incremental /app/data/increment/ --incremental-basedir=/app/data/all/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_21<span class="hljs-number">-14</span><span class="hljs-number">-54</span>
</div><div class="hljs-line">
</div><div class="hljs-line"># 查看增量备份的LSN编号
</div><div class="hljs-line"># cat /app/data/increment/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_21<span class="hljs-number">-22</span><span class="hljs-number">-04</span>/xtrabackup_checkpoints 
</div><div class="hljs-line">backup_type = incremental
</div><div class="hljs-line">from_lsn = <span class="hljs-number">1719643</span>
</div><div class="hljs-line">to_lsn = <span class="hljs-number">1720617</span>
</div><div class="hljs-line">last_lsn = <span class="hljs-number">1720617</span>
</div><div class="hljs-line">compact = <span class="hljs-number">0</span>
</div><div class="hljs-line">recover_binlog_info = <span class="hljs-number">0</span>
</div></code></pre>

<p><strong>第四步： 第二次增量备份</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs lsl"><div class="hljs-line"># 修改数据
</div><div class="hljs-line">update courses.students set major=<span class="hljs-string">"math"</span> where id between <span class="hljs-number">56</span> and <span class="hljs-number">60</span>;
</div><div class="hljs-line">
</div><div class="hljs-line"># 增量备份
</div><div class="hljs-line">innobackupex -ubkuser -p123 -H172<span class="hljs-number">.18</span><span class="hljs-number">.17</span><span class="hljs-number">.21</span> --incremental /app/data/increment/ --incremental-basedir=/app/data/increment/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_21<span class="hljs-number">-22</span><span class="hljs-number">-04</span>
</div><div class="hljs-line">
</div><div class="hljs-line"># 查看增量备份的LSN编号
</div><div class="hljs-line"># cat /app/data/increment/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_21<span class="hljs-number">-25</span><span class="hljs-number">-28</span>/xtrabackup_checkpoints 
</div><div class="hljs-line">backup_type = incremental
</div><div class="hljs-line">from_lsn = <span class="hljs-number">1720617</span>
</div><div class="hljs-line">to_lsn = <span class="hljs-number">1722266</span>
</div><div class="hljs-line">last_lsn = <span class="hljs-number">1722266</span>
</div><div class="hljs-line">compact = <span class="hljs-number">0</span>
</div><div class="hljs-line">recover_binlog_info = <span class="hljs-number">0</span>
</div><div class="hljs-line">
</div><div class="hljs-line"># 查看二进制日志名字及位置
</div><div class="hljs-line">cat /app/data/increment/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_21<span class="hljs-number">-25</span><span class="hljs-number">-28</span>/xtrabackup_binlog_info 
</div><div class="hljs-line">log-bin<span class="hljs-number">.000001</span>  <span class="hljs-number">681</span>
</div></code></pre>

<p><strong>第五步：模拟数据库崩溃</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs gherkin"><div class="hljs-line"><span class="hljs-comment"># 1. 破坏前修改数据库，为演示使用二进制日志恢复做准备</span>
</div><div class="hljs-line">MariaDB&gt; delete from courses.students where id in (51,53,55);
</div><div class="hljs-line">MariaDB&gt; select <span class="hljs-symbol">*</span> from courses.students;
</div><div class="hljs-line">+----+-------+--------+
</div><div class="hljs-line">|<span class="hljs-string"> id </span>|<span class="hljs-string"> name  </span>|<span class="hljs-string"> major  </span>|
</div><div class="hljs-line">+----+-------+--------+
</div><div class="hljs-line">|<span class="hljs-string"> 52 </span>|<span class="hljs-string"> stu52 </span>|<span class="hljs-string"> Engish </span>|
</div><div class="hljs-line">|<span class="hljs-string"> 54 </span>|<span class="hljs-string"> stu54 </span>|<span class="hljs-string"> Engish </span>|
</div><div class="hljs-line">|<span class="hljs-string"> 56 </span>|<span class="hljs-string"> stu56 </span>|<span class="hljs-string"> math   </span>|
</div><div class="hljs-line">|<span class="hljs-string"> 57 </span>|<span class="hljs-string"> stu57 </span>|<span class="hljs-string"> math   </span>|
</div><div class="hljs-line">|<span class="hljs-string"> 58 </span>|<span class="hljs-string"> stu58 </span>|<span class="hljs-string"> math   </span>|
</div><div class="hljs-line">|<span class="hljs-string"> 59 </span>|<span class="hljs-string"> stu59 </span>|<span class="hljs-string"> math   </span>|
</div><div class="hljs-line">|<span class="hljs-string"> 60 </span>|<span class="hljs-string"> stu60 </span>|<span class="hljs-string"> math   </span>|
</div><div class="hljs-line">+----+-------+--------+
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-comment"># 2. 模拟数据库崩溃</span>
</div><div class="hljs-line">systemctl stop mariadb
</div><div class="hljs-line">rm /var/lib/mysql/<span class="hljs-symbol">*</span> -rf
</div></code></pre>

<p><strong>第六步：恢复前准备工作</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs lsl"><div class="hljs-line"># <span class="hljs-number">1.</span> 备份二进制日志
</div><div class="hljs-line">cp /app/data/log/log-bin<span class="hljs-number">.000001</span> /app/data/
</div><div class="hljs-line">
</div><div class="hljs-line"># <span class="hljs-number">2.</span> 合并备份
</div><div class="hljs-line"># <span class="hljs-number">2.1</span> 合并全量，不回滚日志
</div><div class="hljs-line">innobackupex --redo-only --apply-log /app/data/all/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_21<span class="hljs-number">-14</span><span class="hljs-number">-54</span>
</div><div class="hljs-line"># <span class="hljs-number">2.2</span> 合并第一次量，不回滚日志
</div><div class="hljs-line">innobackupex --redo-only --apply-log /app/data/all/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_21<span class="hljs-number">-14</span><span class="hljs-number">-54</span> --incremental-dir=/app/data/increment/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_21<span class="hljs-number">-22</span><span class="hljs-number">-04</span>
</div><div class="hljs-line"># <span class="hljs-number">2.2</span> 合并第二次量，不回滚日志
</div><div class="hljs-line">innobackupex --redo-only --apply-log /app/data/all/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_21<span class="hljs-number">-14</span><span class="hljs-number">-54</span> --incremental-dir=/app/data/increment/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_21<span class="hljs-number">-25</span><span class="hljs-number">-28</span>
</div><div class="hljs-line"># <span class="hljs-number">2.3</span> 提交并回滚日志
</div><div class="hljs-line">innobackupex --apply-log /app/data/all/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_21<span class="hljs-number">-14</span><span class="hljs-number">-54</span>
</div><div class="hljs-line">
</div><div class="hljs-line"># 查看合并后的备份LSN编号，检查合并是否成功
</div><div class="hljs-line">cat /app/data/all/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_21<span class="hljs-number">-14</span><span class="hljs-number">-54</span>/xtrabackup_checkpoints 
</div><div class="hljs-line">backup_type = full-prepared
</div><div class="hljs-line">from_lsn = <span class="hljs-number">0</span>
</div><div class="hljs-line">to_lsn = <span class="hljs-number">1722266</span>
</div><div class="hljs-line">last_lsn = <span class="hljs-number">1722266</span>
</div><div class="hljs-line">compact = <span class="hljs-number">0</span>
</div><div class="hljs-line">recover_binlog_info = <span class="hljs-number">0</span>
</div><div class="hljs-line">
</div><div class="hljs-line"># 查看合并后的日志名称及位置
</div><div class="hljs-line">cat /app/data/all/<span class="hljs-number">2017</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span>_21<span class="hljs-number">-14</span><span class="hljs-number">-54</span>/xtrabackup_binlog_info 
</div><div class="hljs-line">log-bin<span class="hljs-number">.000001</span>  <span class="hljs-number">681</span>
</div></code></pre>

<p><strong>第七步：恢复</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs crystal"><div class="hljs-line"><span class="hljs-comment"># 恢复</span>
</div><div class="hljs-line">innobackupex --copy-back /app/data/all/<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">11_21</span>-<span class="hljs-number">14</span>-<span class="hljs-number">54</span>
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-comment"># 修改属主属组</span>
</div><div class="hljs-line">chown -R <span class="hljs-symbol">mysql:</span>mysql /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">mysql</span></span>
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-comment"># 启动数据库</span>
</div></code></pre>

<p><strong>第八步： 使用二进制日志重放完成最后崩溃前的恢复</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs fortran"><div class="hljs-line"># 恢复时关闭二进制日志记录功能
</div><div class="hljs-line">MariaDB&gt; set @@session.sql_log_bin=<span class="hljs-number">0</span>;
</div><div class="hljs-line">
</div><div class="hljs-line"># 恢复
</div><div class="hljs-line">mysqlbinlog --start-<span class="hljs-keyword">position</span>=<span class="hljs-number">681</span> /app/<span class="hljs-keyword">data</span>/<span class="hljs-built_in">log</span>-bin<span class="hljs-number">.000001</span> &gt; /app/<span class="hljs-keyword">data</span>/<span class="hljs-built_in">log</span>-bin.sql
</div><div class="hljs-line">mysql &lt; /app/<span class="hljs-keyword">data</span>/<span class="hljs-built_in">log</span>-bin.sql
</div></code></pre>

<p><strong>第九步：做一次全量备份</strong></p>



<pre class="prettyprint hljs-dark"><code class="hljs lsl"><div class="hljs-line">innobackupex -ubkuser -p123 -H172<span class="hljs-number">.18</span><span class="hljs-number">.17</span><span class="hljs-number">.21</span> /app/data/all/
</div></code></pre></div></body></html>
